<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Doc Portal Compare</title>
  <link rel="icon" href="https://docs.reltio.com/favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a33;
      --text:#e7ecff;
      --muted:#aab3d6;
      --accent:#6ee7ff;
      --border:rgba(255,255,255,.12);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Libre Franklin",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #14234a 0%, var(--bg) 55%),
                  radial-gradient(900px 700px at 90% 10%, #0c4a6e 0%, rgba(11,18,32,0) 55%);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;
      background: rgba(16,26,51,.72);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      backdrop-filter: blur(10px);
    }
    .title h1{margin:0 0 6px;font-size:20px;font-weight:600;letter-spacing:.2px}
    .title p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}

    .card{
      margin-top:14px;
      background: rgba(16,26,51,.55);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .row{display:grid;grid-template-columns: 1fr;gap:12px}
    .row2{display:grid;grid-template-columns: 1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns: 1fr 1fr 1fr;gap:12px}
    .row4{display:grid;grid-template-columns: 1fr 1fr 1fr 1fr;gap:12px}

    input, select, button{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    button{
      cursor:pointer;
      font-weight:700;
      border-color: rgba(110,231,255,.45);
      background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(110,231,255,.06));
    }
    button:hover{border-color: rgba(110,231,255,.85)}
    button.secondary{
      font-weight:600;
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
    }
    button.danger{
      font-weight:700;
      border-color: rgba(255,120,120,.35);
      background: rgba(255,120,120,.10);
    }
    button.danger:hover{border-color: rgba(255,120,120,.6)}
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    .mini{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .mini code{
      color:var(--text);
      background: rgba(0,0,0,.25);
      padding:2px 6px;
      border-radius: 8px;
      border:1px solid rgba(255,255,255,.10);
    }
    .status{
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
      min-height: 18px;
    }
    @media (max-width: 980px){
      .row2,.row3,.row4{grid-template-columns:1fr}
      header{flex-direction:column}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Doc Portal Compare</h1>
        <p>Paste a docs URL, pick two environments, then open them side-by-side in two reusable windows.</p>
      </div>
    </header>

    <div class="card">
      <div class="row">
        <input id="urlInput" placeholder="Paste full docs URL (PROD / STAGING / UAT)..." />

        <div class="row2">
          <select id="leftEnv" aria-label="Left environment"></select>
          <select id="rightEnv" aria-label="Right environment"></select>
        </div>

        <div class="row3">
          <button id="compareBtn" title="Opens/updates two reusable windows side-by-side">Compare</button>
          <button class="secondary" id="swapBtn" title="Swap environments">Swap</button>
          <button class="secondary" id="copyBtn" title="Copy both URLs">Copy URLs</button>
        </div>

        <div class="row4">
          <button class="secondary" id="openTabsBtn" title="Fallback: open in tabs">Open in tabs</button>
          <button class="secondary" id="copyLinkBtn" title="Copy shareable compare link">Copy compare link</button>
          <button class="secondary" id="focusBtn" title="Bring compare windows to the front">Bring windows to front</button>
          <button class="danger" id="closeBtn" title="Close compare windows">Close windows</button>
        </div>

        <div class="mini">
          For true side-by-side, allow pop-ups for <code>luisjguedes.github.io</code> (one-time).
          Tip: Use OS window snapping (Win+←/→ or macOS Tile Windows) for perfect alignment if your browser restricts positioning.
        </div>

        <div class="status" id="status"></div>
      </div>
    </div>
  </div>

<script>
  // === Configure environments here ===
  const envMap = {
    PROD:   "https://docs.reltio.com/en",
    STAGING:"https://reltio-staging.portal.heretto.com/en",
    UAT:    "https://reltio-preview.portal.heretto.com/en"
  };

  const envPatterns = {
    PROD:   ["https://docs.reltio.com/en"],
    STAGING:["https://reltio-staging.portal.heretto.com/en","https://docstaging.reltio.com/en"],
    UAT:    ["https://reltio-preview.portal.heretto.com/en"]
  };

  const urlInput = document.getElementById("urlInput");
  const leftEnv = document.getElementById("leftEnv");
  const rightEnv = document.getElementById("rightEnv");
  const compareBtn = document.getElementById("compareBtn");
  const openTabsBtn = document.getElementById("openTabsBtn");
  const swapBtn = document.getElementById("swapBtn");
  const copyBtn = document.getElementById("copyBtn");
  const copyLinkBtn = document.getElementById("copyLinkBtn");
  const focusBtn = document.getElementById("focusBtn");
  const closeBtn = document.getElementById("closeBtn");
  const statusEl = document.getElementById("status");

  function setStatus(msg){ statusEl.textContent = msg || ""; }

  // Track window handles so we can focus/close them later
  let leftWinHandle = null;
  let rightWinHandle = null;

  function hasOpenWindows(){
    return (!!leftWinHandle && !leftWinHandle.closed) || (!!rightWinHandle && !rightWinHandle.closed);
  }

  function updateWindowButtons(){
    const any = hasOpenWindows();
    focusBtn.disabled = !any;
    closeBtn.disabled = !any;
  }

  // Populate env dropdowns
  Object.keys(envMap).forEach(env=>{
    leftEnv.add(new Option(env, env));
    rightEnv.add(new Option(env, env));
  });
  leftEnv.value = "STAGING";
  rightEnv.value = "PROD";

  function detectPath(inputUrl){
    const url = (inputUrl || "").trim();
    for(const bases of Object.values(envPatterns)){
      for(const base of bases){
        if(url.startsWith(base)){
          return url.slice(base.length) || "/";
        }
      }
    }
    return null;
  }

  function buildUrl(env, path){
    const p = (path || "/").startsWith("/") ? (path || "/") : "/" + (path || "/");
    return envMap[env] + p;
  }

  function currentPathFromQuery(){
    return new URLSearchParams(location.search).get("path") || null;
  }

  function updateShareLink(path){
    const qp = new URLSearchParams();
    qp.set("path", path);
    qp.set("left", leftEnv.value);
    qp.set("right", rightEnv.value);
    history.replaceState(null, "", "?" + qp.toString());
  }

  // Open two named windows and try to position them side-by-side.
  // Named windows means repeated compares reuse the same two windows (no clutter).
  function openSplit(leftUrl, rightUrl){
    const w = Math.max(1200, Math.floor(screen.availWidth * 0.98));
    const h = Math.max(700, Math.floor(screen.availHeight * 0.92));
    const half = Math.floor(w / 2);

    const common =
      "popup=yes,noopener,noreferrer,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes";

    const leftWin = window.open(leftUrl, "doc_left", `${common},width=${half},height=${h}`);
    const rightWin = window.open(rightUrl, "doc_right", `${common},width=${w-half},height=${h}`);

    if(!leftWin || !rightWin){
      setStatus("Pop-ups blocked. Allow pop-ups for this site, then try again.");
      alert("Pop-ups blocked. Allow pop-ups for luisjguedes.github.io, then click Compare again.");
      updateWindowButtons();
      return false;
    }

    // Save handles so we can focus/close later
    leftWinHandle = leftWin;
    rightWinHandle = rightWin;

    // Try to position/resize (some browsers restrict auto-positioning)
    try {
      leftWin.moveTo(0, 0);
      leftWin.resizeTo(half, h);

      rightWin.moveTo(half, 0);
      rightWin.resizeTo(w - half, h);
    } catch (e) {
      // OS snapping still works
    }

    // Bring to front
    try { leftWin.focus(); } catch {}
    try { rightWin.focus(); } catch {}

    setStatus("Opened/updated two reusable windows (doc_left + doc_right).");
    updateWindowButtons();
    return true;
  }

  function openTabs(leftUrl, rightUrl){
    window.open(leftUrl, "_blank", "noopener,noreferrer");
    window.open(rightUrl, "_blank", "noopener,noreferrer");
    setStatus("Opened both environments in tabs.");
  }

  function getPathOrAlert(){
    const input = urlInput.value.trim();
    const detected = detectPath(input);
    const fromQuery = currentPathFromQuery();

    const path = detected || fromQuery;

    if(!path){
      alert("Paste a URL from PROD/STAGING/UAT first (or open a shared compare link).");
      return null;
    }
    return path;
  }

  function compare(){
    const path = getPathOrAlert();
    if(!path) return;

    const l = buildUrl(leftEnv.value, path);
    const r = buildUrl(rightEnv.value, path);

    updateShareLink(path);
    openSplit(l, r);
  }

  compareBtn.addEventListener("click", compare);

  openTabsBtn.addEventListener("click", () => {
    const path = getPathOrAlert();
    if(!path) return;
    const l = buildUrl(leftEnv.value, path);
    const r = buildUrl(rightEnv.value, path);
    updateShareLink(path);
    openTabs(l, r);
  });

  swapBtn.addEventListener("click", () => {
    const tmp = leftEnv.value;
    leftEnv.value = rightEnv.value;
    rightEnv.value = tmp;
    setStatus("Swapped environments.");
  });

  copyBtn.addEventListener("click", async () => {
    const path = getPathOrAlert();
    if(!path) return;
    const l = buildUrl(leftEnv.value, path);
    const r = buildUrl(rightEnv.value, path);

    const text = `LEFT (${leftEnv.value}): ${l}\nRIGHT (${rightEnv.value}): ${r}`;
    try {
      await navigator.clipboard.writeText(text);
      setStatus("Copied both URLs to clipboard.");
    } catch {
      setStatus("Could not copy automatically. Your browser may block clipboard access.");
      alert(text);
    }
  });

  copyLinkBtn.addEventListener("click", async () => {
    const path = getPathOrAlert();
    if(!path) return;
    updateShareLink(path);
    try {
      await navigator.clipboard.writeText(location.href);
      setStatus("Copied compare link.");
    } catch {
      setStatus("Could not copy automatically. Copy from the address bar.");
    }
  });

  // ✅ New: Bring compare windows to the front
  focusBtn.addEventListener("click", () => {
    let did = false;
    if(leftWinHandle && !leftWinHandle.closed){
      try { leftWinHandle.focus(); did = true; } catch {}
    }
    if(rightWinHandle && !rightWinHandle.closed){
      try { rightWinHandle.focus(); did = true; } catch {}
    }
    setStatus(did ? "Brought compare windows to the front." : "No open compare windows found.");
    updateWindowButtons();
  });

  // ✅ New: Close compare windows
  closeBtn.addEventListener("click", () => {
    let did = false;
    if(leftWinHandle && !leftWinHandle.closed){
      try { leftWinHandle.close(); did = true; } catch {}
    }
    if(rightWinHandle && !rightWinHandle.closed){
      try { rightWinHandle.close(); did = true; } catch {}
    }
    leftWinHandle = null;
    rightWinHandle = null;
    setStatus(did ? "Closed compare windows." : "No open compare windows to close.");
    updateWindowButtons();
  });

  // Enter key
  urlInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") compare();
  });

  // Init from query params (shared links)
  (function initFromQuery(){
    const qp = new URLSearchParams(location.search);
    const path = qp.get("path");
    const left = qp.get("left");
    const right = qp.get("right");

    if(left && envMap[left]) leftEnv.value = left;
    if(right && envMap[right]) rightEnv.value = right;

    if(path){
      urlInput.value = buildUrl(rightEnv.value, path);
      setStatus("Loaded from shared link. Click Compare to open side-by-side.");
    }
    updateWindowButtons();
  })();

  // Keep buttons fresh if user closes windows manually
  setInterval(updateWindowButtons, 1200);
</script>
</body>
</html>
